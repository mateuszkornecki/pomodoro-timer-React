<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel='stylesheet' href="css/main.css">
    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body>
    <div class="root"></div>

    <script type='text/babel'>

             function App(){
                return(
                <div className="App">
                    <TimeboxEditor />
                    <Timebox />
                </div>
                )
            }

            function timeInterval(min, max, value) {
                //It will return a number between min and max
                value = Math.max(min, Math.min(value, max))
                return value;
            }

            function fillWithZeros(targetLength, value) {
                //It will add zeros  before value till value.length = targetLength
                value = value.toString();
                while (value.length < targetLength){
                    value = `0${value}`
                }
                return value;
            }

            function normalizeTime (min, max, targetLength, value) {
               return fillWithZeros(targetLength, timeInterval(min, max, value));
            }

            function Clock({className="", hours, minutes, seconds, miliseconds}) {
                hours = normalizeTime(0, 23, 2, hours);
                minutes = normalizeTime(0, 59, 2, minutes);
                seconds = normalizeTime(0, 59, 2, seconds);
                miliseconds = normalizeTime(0, 999, 3, miliseconds);
            
                return <h2 className={"Clock " + className} > Pozostało {hours}:{minutes}:{seconds}:{miliseconds}</h2>  
            }

            function ProgressBar({className="", percent, trackRemaining}){
                const ProgressBarClasses = trackRemaining === true ? `ProgressBar ProgressBar--reverse ${className}` : `ProgressBar ${className}`;
                const ProgressBarWidth = trackRemaining === true ? `calc(100% - ${percent}%)` : `${percent}%`;
                
                return (
                    <div className={ProgressBarClasses}>
                        <div style={{width: `${ProgressBarWidth}`}}></div>
                    </div>
                )
            }

            class TimeboxEditor extends React.Component {

                state = {
                    taskInputValue: "Ucze się skrótów klawiszowych",
                    taskInputTime: 225,
                }

                handleChangeTaskInputValue = (e) => {
                    this.setState({
                        taskInputValue: e.target.value 
                    })
                }

                hangleChangeTaskTime = (e) => {
                    this.setState({
                        taskInputTime: e.target.value
                    })
                }

                render() {
                    const {taskInputValue, taskInputTime} = this.state;
                    return(
                        <div className="TimeboxEditor">
                            <label htmlFor="taskInput">Co robisz?</label><input id="taskInput" onChange={this.handleChangeTaskInputValue} type="text" defaultValue={taskInputValue} /><br />
                            <label htmlFor="timeInput">Ile minut?</label><input id="timeInput" onChange={this.handleChangeTaskTime} type="number" defaultValue={taskInputTime} /><br />
                            <button disabled>Zacznij</button>
                         </div>
                    )
                }
            }       

            class Timebox extends React.Component {
                constructor(props) {
                    super(props);
                    this.state ={
                        isRunning: false,
                        isPaused: false,
                        pausesCount: 0,
                        initialTime: 0,
                        actualTime: 0,
                        taskTime: 0,
                        initialTaskTime: 0,
                        endTime: 0,
                        remainingTime: 0,
                        actualPercent: 0
                    }
                    this.handleStart = this.handleStart.bind(this);
                    this.handleStop = this.handleStop.bind(this);
                    this.togglePause = this.togglePause.bind(this);
                    this.start = this.start.bind(this);
                    this.stop = this.stop.bind(this);
                    this.repause = this.repause.bind(this);
                    this.setTaskTime = this.setTaskTime.bind(this);
                    this.setEndTime = this.setEndTime.bind(this);
                    this.setRemainingTime = this.setRemainingTime.bind(this);
                    this.setActualPercent = this.setActualPercent.bind(this);
                    this.forceStop = this.forceStop.bind(this);
                    let countDown;   
                }
                
                start() {                       
                    this.countDown = setInterval( () => {
                        let actualTime = Date.now();
                        this.setState({
                            actualTime: actualTime,
                        })
                        // keeps remaining time actual
                        this.setRemainingTime();
                        this.setActualPercent();
                        this.forceStop();
                    }, 10)
                }

                stop() {
                    clearInterval(this.countDown);
                }

                forceStop() {
                    const {remainingTime} = this.state; 
                    if (remainingTime <= 0) {
                        this.stop();
                    }
                }

                repause() {
                    //create new initialTime, use remainingTime as new taskTime
                    const {remainingTime, taskTime} = this.state; 
                    const initialTime = Date.now();
                    const newTaskTime = remainingTime * 1000
                    this.setState({
                        isRunning: true,
                        initialTime: initialTime,
                        taskTime: newTaskTime,
                    })
                    this.start();
                    this.setEndTime();
                    
                }

                setTaskTime(seconds) {
                    this.setState({
                    taskTime: seconds * 1000,
                    initialTaskTime: seconds * 1000
                    })
                }

                setEndTime(){
                    this.setState(
                        function(prevState){
                            let endTime = prevState.initialTime + prevState.taskTime;
                            return{
                                endTime: endTime,
                            }
                        }
                    )
                }

                setRemainingTime(){
                    this.setState(
                        function(prevState){
                            let remainingTime = (prevState.endTime - prevState.actualTime)/1000;
                            return{
                                remainingTime: remainingTime
                            }
                        }
                    )
                }

                setActualPercent(){  
                    this.setState(
                        function(prevState){
                            //*1000 to convert seconds to ms and *100 to convert fraction to a full number
                            let actualPercent = 100-((prevState.remainingTime*1000)/prevState.initialTaskTime)*100;
                            return{
                                actualPercent: actualPercent
                            }
                        }
                    )
                }

               handleStart() {
                const {taskTime} = this.state;
                const initialTime = Date.now();
                    this.setState({
                        isRunning: true,
                        initialTime: initialTime,
                    })
                    this.start();
                    this.setTaskTime(10);
                    this.setEndTime();
                    
                }
                handleStop() {
                    this.stop();
                    this.setState({
                        isRunning: false,
                        isPaused: false,
                        pausesCount: 0,
                        initialTime: 0,
                        actualTime: 0,
                        taskTime: 0,
                        endTime: 0,
                        remainingTime: 0,
                        actualPercent: 0
                    })
                    
                }

                togglePause() {
                    this.setState(
                        function(prevState){
                            const isPaused = !prevState.isPaused
                            return{
                                isPaused: isPaused,
                                pausesCount: prevState.isPaused ? prevState.pausesCount + 1 : prevState.pausesCount
                            }
                        }
                    )
                    const  {isPaused} = this.state;
                    isPaused ? this.repause() : this.stop();
                }

                render() {
                    const  {isRunning, isPaused, pausesCount, initialTime, actualTime, taskTime, endTime, remainingTime, actualPercent} = this.state;
                    let fullSec = Math.floor(remainingTime);
                    let hours = Math.floor(remainingTime / 3600);
                    let minutes = Math.floor(remainingTime / 60);
                    let seconds = Math.floor(remainingTime % 60);
                    //to prevent counting after passing 0
                    let ms = (fullSec >= 0) ? Math.floor((remainingTime - fullSec)*1000) : 0;
                    
                    return(
                        <div className="Timebox">
                            <h1>Ucze się skrótów klawiszowych</h1>
                            <Clock className={ isPaused ? "inactive" : ""} hours={hours} minutes={minutes} seconds={seconds} miliseconds={ms}/> 
                            <ProgressBar className={ isPaused ? "inactive" : ""} percent={actualPercent} trackRemaining={false} />
                            <button onClick={this.handleStart} disabled={isRunning}>Start</button>
                            <button onClick={this.handleStop} disabled={!isRunning}>Stop</button>
                            <button onClick={this.togglePause} disabled={!isRunning}>{isPaused ? 'Wznów' : 'Pauzuj'}</button>
                            Liczba przerw: {pausesCount}
                        </div>
                    )
                }
            }

                ReactDOM.render(<App />, document.querySelector('.root'));

        </script>
</body>

</html>