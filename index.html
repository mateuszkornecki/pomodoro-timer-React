<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel='stylesheet' href="css/main.css">
    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body>
    <div class="root"></div>

    <script type='text/babel'>

             function App(){
                return(
                <div className="App">
                    <EditableTimebox/>
                </div>
                )
            }

            function timeInterval(min, max, value) {
                //It will return a number between min and max
                value = Math.max(min, Math.min(value, max))
                return value;
            }

            function fillWithZeros(targetLength, value) {
                //It will add zeros  before value till value.length = targetLength
                value = value.toString();
                while (value.length < targetLength){
                    value = `0${value}`
                }
                return value;
            }

            function normalizeTime (min, max, targetLength, value) {
               return fillWithZeros(targetLength, timeInterval(min, max, value));
            }

            function Clock({className="", hours, minutes, seconds, miliseconds}) {
                hours = normalizeTime(0, 24, 2, hours);
                minutes = normalizeTime(0, 59, 2, (minutes >= 60) ? minutes%60 : minutes);
                seconds = normalizeTime(0, 59, 2, seconds);
                miliseconds = normalizeTime(0, 999, 3, miliseconds);
                
                //?fix - should be reworked for stand alone function?
                // minutes = 60 ? '00' : minutes;
                // seconds = 60 ? '00' : seconds;
                // miliseconds = 1000 ? '000' : miliseconds;

                return <h2 className={"Clock " + className} > Pozostało {hours}:{minutes}:{seconds}:{miliseconds}</h2>  
            }

            function ProgressBar({className="", percent, trackRemaining}){
                const ProgressBarClasses = trackRemaining === true ? `ProgressBar ProgressBar--reverse ${className}` : `ProgressBar ${className}`;
                const ProgressBarWidth = trackRemaining === true ? `calc(100% - ${percent}%)` : `${percent}%`;
                
                return (
                    <div className={ProgressBarClasses}>
                        <div style={{width: `${ProgressBarWidth}`}}></div>
                    </div>
                )
            }

            class EditableTimebox extends React.Component {
                state = {
                    title: "To pole powinno działać",
                    taskTimeInSeconds: 10,
                }

                handleChangeTitle = (e) => {
                    this.setState({
                        title: e.target.value 
                    })
                }

                handleChangeTaskTime = (e) => {
                    this.setState({
                        //* 60 to convert seconds to minutes
                        taskTimeInSeconds: e.target.value * 60
                    })
                }


                render(){
                    const {title, taskTimeInSeconds} = this.state;
                    return(
                        <>
                            <TimeboxEditor 
                                title={title}
                                taskTimeInSeconds={taskTimeInSeconds}
                                onChangeTitle={this.handleChangeTitle} 
                                onChangeTaskTime={this.handleChangeTaskTime} 
                            />
                            <Timebox 
                                title={title}  
                                taskTimeInSeconds={taskTimeInSeconds} 
                            />
                        </>
                    )
                }

            }

            class TimeboxEditor extends React.Component {
        
                render() {
                    const {title, taskTimeInSeconds, onChangeTitle, onChangeTaskTime} = this.props;
                    return(
                        <div className="TimeboxEditor">
                            <label htmlFor="taskInput">Co robisz?</label>
                            <input 
                                id="taskInput" 
                                onChange={onChangeTitle} 
                                type="text" defaultValue={title} 
                            />
                            <br />
                            <label htmlFor="timeInput">Ile minut?</label>
                            <input 
                                id="timeInput" 
                                onChange={onChangeTaskTime} 
                                type="number" 
                                defaultValue={taskTimeInSeconds} 
                            />
                            <br />
                            <button disabled>Zacznij</button>
                         </div>
                    )
                }
            }       

            class Timebox extends React.Component {
                constructor(props) {
                    super(props);
                    this.state ={
                        isRunning: false,
                        isPaused: false,
                        pausesCount: 0,
                        initialTime: 0,
                        actualTime: 0,
                        taskTimeInMs: 0,
                        initialTaskTime: 0,
                        endTime: 0,
                        remainingTime: 0,
                        actualPercent: 0
                    }
                    let countDown;   
                }
                
                start = () => {                       
                    this.countDown = setInterval( () => {
                        let actualTime = Date.now();
                        this.setState({
                            actualTime: actualTime,
                        })
                        // keeps remaining time actual
                        this.setRemainingTime();
                        this.setActualPercent();
                        this.forceStop();
                    }, 10)
                }

                stop = () => {
                    clearInterval(this.countDown);
                }

                forceStop = () => {
                    const {remainingTime} = this.state; 
                    if (remainingTime <= 0) {
                        this.stop();
                    }
                }

                repause = () => {
                    //create new initialTime, use remainingTime as new taskTimeInMsInMiliseconds
                    const {remainingTime, taskTimeInMs} = this.state; 
                    const initialTime = Date.now();
                    const taskTimeAfterPause = remainingTime * 1000
                    this.setState({
                        isRunning: true,
                        initialTime: initialTime,
                        taskTimeInMs: taskTimeAfterPause,
                    })
                    this.start();
                    this.setEndTime();
                    
                }

                setTaskTime = (seconds) => {
                    this.setState({
                    taskTimeInMs: seconds * 1000,
                    initialTaskTime: seconds * 1000
                    })
                }

                setEndTime = () => {
                    this.setState(
                        function(prevState){
                            let endTime = prevState.initialTime + prevState.taskTimeInMs;
                            return{
                                endTime: endTime,
                            }
                        }
                    )
                }

                setRemainingTime = () =>{
                    this.setState(
                        function(prevState){
                            let remainingTime = (prevState.endTime - prevState.actualTime)/1000;
                            return{
                                remainingTime: remainingTime
                            }
                        }
                    )
                }

                setActualPercent = () =>{  
                    this.setState(
                        function(prevState){
                            //*1000 to convert seconds to ms and *100 to convert fraction to a full number
                            let actualPercent = 100-((prevState.remainingTime*1000)/prevState.initialTaskTime)*100;
                            return{
                                actualPercent: actualPercent
                            }
                        }
                    )
                }

               handleStart = () => {
                const {taskTimeInMs} = this.state;
                const {taskTimeInSeconds} = this.props;
                const initialTime = Date.now();
                    this.setState({
                        isRunning: true,
                        initialTime: initialTime,
                    })
                    this.start();
                    this.setTaskTime(taskTimeInSeconds);
                    this.setEndTime();
                    
                }
                handleStop = () => {
                    this.stop();
                    this.setState({
                        isRunning: false,
                        isPaused: false,
                        pausesCount: 0,
                        initialTime: 0,
                        actualTime: 0,
                        taskTimeInMs: 0,
                        endTime: 0,
                        remainingTime: 0,
                        actualPercent: 0
                    })
                    
                }

                togglePause= () => {
                    this.setState(
                        function(prevState){
                            const isPaused = !prevState.isPaused
                            return{
                                isPaused: isPaused,
                                pausesCount: prevState.isPaused ? prevState.pausesCount + 1 : prevState.pausesCount
                            }
                        }
                    )
                    const  {isPaused} = this.state;
                    isPaused ? this.repause() : this.stop();
                }

                

                render() {
                    const  {isRunning, isPaused, pausesCount, initialTime, actualTime, taskTimeInMs, endTime, remainingTime, actualPercent} = this.state;
                    const {title, taskTimeInSeconds} = this.props;
                    
                    let hours;
                    let minutes;
                    let seconds;
                    let ms;
                    let fullSec;
                    
                    const reworkTime = (value) =>{
                        fullSec = Math.floor(value);
                        hours = Math.floor(value / 3600);
                        minutes = Math.floor(value / 60);
                        seconds = Math.floor(value % 60);
                    //to prevent counting after passing 0
                        ms = (fullSec >= 0) ? Math.floor((value - fullSec)*1000) : 0;
                    // return(hours, minutes, seconds, ms);
                }
                    //if timebox is not running display time entered in input else display  remaining time
                    reworkTime(isRunning ? remainingTime : taskTimeInSeconds);
                    console.log([remainingTime, taskTimeInSeconds])
                    return(
                        <div className="Timebox">
                            <h1>{title}</h1>
                            <Clock className={ isPaused ? "inactive" : ""} hours={hours} minutes={minutes} seconds={seconds} miliseconds={ms}/> 
                            <ProgressBar className={ isPaused ? "inactive" : ""} percent={actualPercent} trackRemaining={false} />
                            <button onClick={this.handleStart} disabled={isRunning}>Start</button>
                            <button onClick={this.handleStop} disabled={!isRunning}>Stop</button>
                            <button onClick={this.togglePause} disabled={!isRunning}>{isPaused ? 'Wznów' : 'Pauzuj'}</button>
                            Liczba przerw: {pausesCount}
                        </div>
                    )
                }
            }

                ReactDOM.render(<App />, document.querySelector('.root'));

        </script>
</body>

</html>